---
titulo: "Análise de Dados Categorizados"
subtitulo: "Trabalho Final"
aluno1:  "Carolina Musso 18/0047850"
aluno2: "Juliana Magalhães Rosa 18/0020935"
orientador: "Maria Teresa Leão"
ano: "1/2023"
referencias: auxiliar/referencias.bib
output: 
  bookdown::pdf_document2:
    template: auxiliar/template.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

```{r bibliotecas, include=FALSE}

#rm(list = ls()) #will clear all objects includes hidden objects.
#options(rstudio.help.showDataPreview = FALSE)
# Carregando bibliotecas ---------
pacman::p_load(tidyverse, dplyr, rio, papeR, patchwork, 
               kableExtra, pROC, ExhaustiveSearch)


# Bases -----

dados <- import ("data/dados_trabalho.xlsx")

# amostra
set.seed(42)
amostra <- slice_sample(dados, n=100)

## Tratamento ----

names(amostra) <- c("ID", "idade", "status", "casa", "setor", "save" )

amostra_trat <- amostra %>% 
  mutate(status=factor(status, 
                       labels=c("Superior", "Medio", "Inferior")), 
         casa=factor(casa, labels=c("Nao", "Sim")), 
         setor=factor(setor, levels=c(1,0), labels=c("B", "A")),
        save=factor(save, labels=c("Nao", "Sim"))) %>% 
  as.data.frame()
```

\newpage

# Introdução e Objetivos

A habilidade e a possibilidade de poupar dinheiro pode estar relacionada a diversos fatores. \citeonline{economics} cita a idade, poder aquisitivo, desenvolvimento econômico e inflação como possíveis questões associadas. 

Este trabalho visa avaliar fatores associados à posse de conta poupança por parte de pacientes de uma rede hospitalar. Isso será feito por meio da seleção de um modelo de regressão logística. 

# Metodologia


## Variáveis 

A variável resposta analisada nesse estudo é qualitativa nominal binária, "Conta popuança". 

As variáveis explicativas (ou os fatores possivelmente associados) são:

- Idade: variável quantitativa discreta medida em anos;

- Status socioeconômico: variável qualitativa ordinal medida em 1 = superior, 2 = médio , 3 = inferior;

- Possui casa própria: variável qualitativa nominal binária, medida em 2 = não ou sim, mas ainda pagando financiamento e 2= sim e quitada;

- Setor da cidade: variável qualitativa nominal medida em 1 = setor A; 0= setor B.


## Amostra

Para este trabalho, uma sub-amostra aleatória simples sem reposição de tamanho 100 foi selecionada a partir de uma amostra de 196 pacientes. Os IDS selecionados nesse trabalho foram: 2, 3, 4, 5, 6, 9, 13, 16, 18, 20, 21, 24, 27, 29, 32, 33, 35, 36, 40, 41, 42, 43, 47, 49, 53, 54, 55, 57, 58, 60, 65, 68, 69, 71, 73, 74, 76, 80, 81, 82, 83, 85, 89, 91, 92, 99, 100, 101, 102, 103, 104, 109, 110, 111, 113, 114, 115, 116, 118, 122, 128, 129, 130, 131, 134, 135, 136, 137, 138, 140, 143, 144, 146, 150, 153, 154, 158, 161, 162, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 179, 180, 182, 183, 184, 185, 187, 191, 192, 194, 196.

```{r include=FALSE}
sort(amostra$ID)
```

## Análise

A regressão logística é um modelo estatístico utilizado para casos em que a variável resposta é categorizada. O mais comum é que essa variável seja binária, como é o caso do presente estudo. O funcionamento dessa técnica consiste em descrever a probabilidade de ocorrência de um evento, que nesse caso será a posse de poupança.

Assim,  modela-se a média da variável resposta a partir da função Logística:

$$\pi(x_i) = \frac{exp{(\beta_0 + \beta_1 x_{i1}+...+\beta_{k-1}x_{i(k-1)})}}{1+exp{(\beta_0 + \beta_1 x_{i1}+...+\beta_{k-1}x_{i(k-1)})}}$$
onde $x_i$ é um vetor com os elementos $x_{ij}$, os quais representam possíveis valores das variáveis explicativas $X_j$; $\beta_j$ é um parâmetro regressivo; $k$ é o número de parâmetros do modelo com $j=0, 1, 2,...,k-1$.

\newpage
# Resultados

## Análise Descritiva: Gráficos


### Distribuição de Idades dos Pacientes

Podemos observar na Figura \ref{fig:idade} a distribuição das idade entre cada grupo de interesse (tem ou não tem poupança). 

```{r}
idade_by <- amostra_trat %>% 
  ggplot(aes(x=save, y=idade, fill=save))+
   geom_boxplot()+
   scale_fill_manual(values=c("#00822E", "#0068B4"))+
   #geom_jitter(color="black", size=0.4, alpha=0.9) +
   theme_classic(base_size = 14)+
   theme(legend.position = "none")+
   labs(x= "Possui Poupanca", y= "Idade (anos)")
   


idade <- amostra_trat %>% 
   ggplot(aes(y=idade))+
   geom_boxplot()+
  #geom_jitter( color="black", size=0.4, alpha=0.9) +
  theme_classic(base_size = 10)+
   theme(legend.position = "none", 
         axis.text.x = element_blank(), 
         axis.ticks = element_blank(),
         axis.line.x = element_blank(),
          axis.line.y = element_blank(),
         panel.border = element_rect(colour = "black", fill=NA))+
   labs(x= "", y= "")+
  ggtitle("Geral")

 
 fig_id <-  idade_by +  inset_element(idade, left = 0.01, bottom = 0.45, right = 0.25, top = 1)

 ggsave(plot=fig_id, filename = "img/idade.png")
```


\begin{figure}[H]
    \centering
    \includegraphics[scale=0.65]{img/idade.png}
    \caption{Diagrama de caixas para distribuição de idade entre os grupos sem (azul) e com (verde) poupança. Para comparação, a distribuiçao de idade geral foi adicionada no canto superior esquerdo.}
    \label{fig:idade}
\end{figure}



### Proporção de Pacientes nos Status Socioeconômicos

```{r}
status_by <- amostra_trat %>% 
  ggplot(aes(x=save,fill=factor(status)))+
   geom_bar(position="fill", color="black")+
   scale_fill_manual(values=c("#00822E", "#7E7E65", "#0068B4"))+
   #geom_jitter(color="black", size=0.4, alpha=0.9) +
   theme_classic(base_size = 14)+
   theme(legend.position = "none")+
   labs(x= "Possui Poupanca", y= "Proporcao")
   


status <-   amostra_trat %>% 
  ggplot(aes(x=1,fill=factor(status)))+
  geom_bar(position="fill", color="black")+
  scale_fill_manual("",values=c("#00822E", "#7E7E65", "#0068B4"))+
  theme_classic(base_size = 14)+
  theme( axis.text.x = element_blank(),
        axis.ticks = element_blank())+
  labs(x= "", y= "", title="Geral")


```


### Proporção de Pacientes com Casa Própria Quitada

```{r}
casa_by <- amostra_trat %>% 
  ggplot(aes(x=save,fill=factor(casa)))+
   geom_bar(position="fill", color="black")+
   scale_fill_manual("", values=c("#00822E", "#0068B4"))+
   #geom_jitter(color="black", size=0.4, alpha=0.9) +
   theme_classic(base_size = 14)+
   theme(legend.position = "none")+
   labs(x= "Possui Poupanca", y= "Proporcao")
   


casa<-   amostra_trat %>% 
  ggplot(aes(x=1,fill=factor(casa)))+
  geom_bar(position="fill", color="black")+
  scale_fill_manual("", values=c("#00822E", "#0068B4"))+
  theme_classic(base_size = 14)+
  theme(axis.text.x = element_blank(),
        axis.ticks = element_blank())+
  labs(x= "", y= "")+
  ggtitle("Geral")
```

```{r fig:idade, out.width="90%"}
 casa_by +  casa +   plot_layout(widths = c(2, 1))
```

### Proporção de Pacientes nos Setores da Cidade

```{r}
setor_by <- amostra_trat %>% 
  ggplot(aes(x=save,fill=factor(setor)))+
   geom_bar(position="fill", color="black")+
   scale_fill_manual("", values=c("#00822E", "#0068B4"))+
   #geom_jitter(color="black", size=0.4, alpha=0.9) +
   theme_classic(base_size = 14)+
   theme(legend.position = "none")+
   labs(x= "Possui Poupanca", y= "Proporcao")
   


setor <-   amostra_trat %>% 
  ggplot(aes(x=1,fill=factor(setor)))+
  geom_bar(position="fill", color="black")+
  scale_fill_manual("", values=c("#00822E", "#0068B4"))+
  theme_classic(base_size = 14)+
  theme(axis.text.x = element_blank(),
        axis.ticks = element_blank())+
  labs(x= "", y= "")+
  ggtitle("Geral")
```

```{r, out.width="90%"}
 setor_by +  setor + plot_layout(widths = c(2, 1))
```

## Análise Descritiva Tabelas

```{r}
names(amostra_trat) <- c("ID", "Idade", "Status Socioeconomico", "Casa Propria", "Setor", "Poupanca" )

```

```{r}

Tab1 <- papeR::summarize(amostra_trat[,-1],
                 type = "factor", group = "Poupanca")
```

```{r, echo = FALSE, cache=F, results = 'asis'}

xtable(Tab1, caption="Frequências dos Fatores Explicativos por Posse de Poupanca.")
```

```{r}
Tab2 <- papeR::summarize(amostra_trat[,-1],
                 type = "numeric", group = "Poupanca")
```

```{r, echo = FALSE, cache=F, results = 'asis'}

xtable(Tab2, width = rep("0.5in", 11), caption="Medidas Descritivas para Idade dos Pacientes por Posse de Poupanca.")
```

Parametros e interpretacao
Modelo e residuos

## Modelagem 

```{r}
#Seleção exaustiva
library(leaps)
sele1<-regsubsets(Poupanca~.,data=amostra_trat[, -1], nbest=10)
n_parametros<-as.numeric(rownames(summary(sele1)$which))+1
s <- summary(sele1)

#Critério R^2
plot(n_parametros,summary(sele1)$rsq, main="Criterio R2", xlab="Numero de Parametros", ylab="R2")

#Critério R^2 ajustado
plot(n_parametros,summary(sele1)$adjr2, main="Criterio R2 Ajustado", xlab="Numero de Parametros", ylab="R2 Ajustado")

#Critério Cp
plot(n_parametros,summary(sele1)$cp, main="Criterio Cp", xlab="Numero de Parametros", ylab="Cp")
#plot(n_parametros, summary(sele1)$cp, ylim=c(0, 10), main="Critério Cp Ampliado", xlab="Número de Parâmetros", ylab="Cp")
abline(h=4)

#Critério bic
plot(n_parametros,summary(sele1)$bic, main="Criterio BIC", xlab="Numero de Parametros", ylab="BIC")

#Modelo com 4 parâmetros (3 variáveis explicativas) parece melhor
#O de 3 parâmetros poderia ser bom também
```

```{r}
#Modelo 6 é o melhor com 3 parâmetros (2 variáveis explicativas)
#Modelo 16 é o melhor com 4 parâmetros (2 variáveis explicativas)
s$outmat[6, ]
s$outmat[16, ]

#com 3 parâmetros fica só com uma das dummies de status socioeconômico
#faz mais sentido pegar de 4 parâmetros

#o melhor modelo de 4 parâmetros é o que inclui status (as 2 dummies) e idade --> conforme já esperávamos pela significância das associações
```


```{r}
mod1 <- glm(data=amostra, save ~ idade+status+casa+setor, binomial(link = "logit"))
mod2 <- glm(data=amostra, save ~ idade+status, binomial(link = "logit"))
```


```{r}
# outra opcao

credit_glm0 <- glm(Poupanca~., family=binomial, data=amostra_trat[,-1])
credit_glm_back <- step(credit_glm0)
summary(credit_glm_back)
```

```{r}
credit_glm_for <- step(credit_glm0, direction = c("both"))
summary(credit_glm_for)
```


```{r}
selecao_exaustiva <- ExhaustiveSearch(save ~ idade + 
                                        factor(status) + 
                                        factor(setor) + 
                                        factor(casa), 
                                      data = amostra[,-1], family = "binomial",
                                      performanceMeasure = "AIC")


plot_AIC_npar <- ExhaustiveSearch::resultTable(selecao_exaustiva) %>% 
  mutate(n_par=str_count(Combination, "\\+")+2)

plot_AIC_npar_labels <- plot_AIC_npar %>% 
  head(3) %>% 
  mutate(label=str_replace_all(Combination, "factor\\(", ""),
         label=str_replace_all(label, "\\)", ""), 
         label=str_squish(label))
         
  
plot_AIC <- plot_AIC_npar %>% 
  ggplot(aes(x=n_par, y=AIC))+
  geom_point()+
  theme_classic(base_size = 16)+
    scale_x_continuous(limits = c(1, 7))+
  labs(x="Número de Parâmetros", y="Critério de Informação de Akaike (AIC)")+
  geom_text(data=plot_AIC_npar_labels,
            aes(label=label), size=3, nudge_x = c(-0.55, 0.7, -0.7))
ggsave("img/AIC.png", width=10)



# a <- ExhaustiveSearch(save ~ idade + status + setor + casa, data = amostra[,-1], family = "binomial",
#   performanceMeasure = "AIC")
# para_plot <- ExhaustiveSearch::resultTable(b) %>% 
#   mutate(n_par=str_count(Combination, "\\+")+2) %>% 
#   select(-Combination)
# plot(para_plot)
# 
# par_mod <- a$ranking$featureIDs
# aic_mod <- a$ranking$performance
# 
# getFeatures(a)
# 
# n_par <- map_dbl( 1:31, ~{
#   length(par_mod[[.]])
# })
# 


```



```{r}

# Realizar a regressão logística com seleção automática de variáveis usando AIC como critério
modelo_automatico <- step(glm(Poupanca ~ ., data = amostra_trat, family = binomial), direction = "both", trace = 0)

# Acessar todos os modelos gerados durante o processo de seleção
todos_os_modelos <- attr(modelo_automatico$terms, "all_models")

# Visualizar os AIC de todos os modelos
modelos_e_aic <- data.frame(AIC = sapply(todos_os_modelos, AIC), Model = 1:length(todos_os_modelos))
print(modelos_e_aic)

```

```{r}
#modelo saturado
mod1$coefficients
```

```{r}
#modelo selecionado
mod2$coefficients
```


```{r fig.height=5, fig.width=5.2}
#ROC --> avaliação do modelo
r <- roc( amostra$save,as.vector(fitted.values(mod1)) , 
          grid=TRUE, print.auc = TRUE, percent=T)


plot(r ,xlim=c(100,0),ylim=c(0,100), asp = NA, legacy.axes = F, xlab="Especificidade (%)", ylab="Sensibilidade (%)",percent=T,print.auc = TRUE, main="Curva ROC" )

rr <- roc( amostra$save,as.vector(fitted.values(mod2)) , 
          grid=TRUE, print.auc = TRUE, percent=T)
plot(rr ,xlim=c(100,0),ylim=c(0,100), asp = NA, legacy.axes = F, xlab="Especificidade (%)", ylab="Sensibilidade (%)",percent=T,print.auc = TRUE, main="Curva ROC" )
```

Como funciona a análise de resíduos para a regressão logística?  
Fiz igual à linear, mas acho que não é assim...  
De toda forma, falta reproduzir para o modelo 2 ainda.

```{r}
## MODELO 1
#gráficos residuais
plot(mod1$fitted.values,mod1$residuals, main="Residuos do Modelo Corrigido vs Valores Ajustados", xlab="Valores Ajustados", ylab="Residuos")
abline(h=0)
plot(mod1$residuals, main="Residuos do Modelo Corrigido em Sequencia", xlab="ID", ylab="Residuos")
qqnorm(mod1$residuals, main="Grafico de Quantis Normais", xlab="Quantis Teoricos", ylab="Residuos")
qqline(mod1$residuals)
```

```{r}
#testes para resíduos
library(lmtest)
bptest(mod1)
shapiro.test(mod1$residuals) #rejeita
```


# Conclusão

\newpage
# Apêndice

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

